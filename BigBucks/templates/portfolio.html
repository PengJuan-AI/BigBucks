{% extends 'base1.html' %}

{% block title %}Portfolio{% endblock %}

{% block main_body %}
<div class="box">
    <div class="col-md-4">
        <div class="box box-warning">
            <div class="box-header with-border text-center">
                <h3 class="box-title"><strong>Currently Owned Assets</strong></h3>
            </div>
            <div class="row">
                <form class="navbar-form navbar-left">
                <div class="form-group">
                    <input type="text" class="form-control" placeholder="Search" id="search-input">
                </div>
                <button type="button" class="btn btn-default" id="search-btn">Search Asset</button>
                </form>
            </div>
            <div class="box-body table-responsive no-padding">
            <form action="#" method="POST">
                <table class="table table-dark" id="portfolio-table">
                    <thead>
                    <tr>
                        <th>Asset Symbol</th>
                        <th>Action</th>
                    </tr>
                    </thead>
                    <tbody>
                        {% for asset in portfolio %}
                        <tr>
                            <td>{{ asset[1] }}</td>
                            <td>
                                <a type="button" href="#" onclick="display_stock_info('{{ asset[1] }}', '{{ asset[2] }}')" class="btn btn-success btn-xs">View Data</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </form>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="box box-primary">
            <div class="box-header with-border text-center">
                <h3 class="box-title"><strong>Asset Information and Data</strong></h3>
            </div>
            <div class="container" style="font-size:16px;color:steelblue">
                <p id="symbol">Asset Symbol: </p>
                <p id="shares">Shares Available: </p>
            </div>
            <div id="chart" style="width: 600px; height: 400px;margin: 1rem auto;"></div>
            <!-- <div id="chart2" style="width: 600px; height: 400px;margin: 1rem auto;"></div> -->
        </div>
        <div class="container">
            <div id="chart1" class="chart-div"></div>
            <div id="chart2" class="chart-div"></div>
            <div id="chart3" class="chart-div"></div>
            <!-- <div id="chart3" class="chart-div"></div> -->
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/echarts@5.1.2/dist/echarts.min.js"></script>

<script>
    function pass_shares(symbol, shares){
        var sy = document.getElementById('symbol');
        sy.innerHTML = "Asset Symbol: " + symbol;
        var sh = document.getElementById('shares');
        sh.innerHTML = "Shares Available: " + shares;
    }

    function display_stock_info(symbol, shares) {
        pass_shares(symbol, shares);
        fetch(`/analysis/portfolio/${symbol}`, {
            method: "POST"
        })
            .then(response => response.json())
            .then(data => {
            // 在 div 中绘制图表
            console.log(symbol);
            console.log(data);
            console.log(data.return.length)
            console.log(data.return_SPY.length)
            draw_historical_data(data, symbol);
            draw_daily_price_movement(data, symbol);
            draw_daily_price_change(data, symbol);
            draw_scatter_graph(data, symbol);
            });
        }
    function draw_historical_data(data, symbol) {
        var chart = echarts.init(document.getElementById("chart"));
            chart.setOption({
                title: {
                    text: 'Historical Data of ' + symbol,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    position: function (pt) {
                    return [pt[0], '10%'];
                    }
                },
                xAxis: {
                type: "category",
                data: data.date,
                boundaryGap: false,
                },
                yAxis: {
                type: "value"
                },
                dataZoom: [
                    {
                    type: 'inside',
                    start: 0,
                    end: 10
                    },
                    {
                    start: 0,
                    end: 10
                    }
                ],
                series: [{
                name: 'price',
                data: data.price,
                type: "line",
                symbol: 'none'
                }]
            });
    }

    function draw_daily_price_movement(data, symbol) {
    // Calculate daily price movement
    let dailyPriceMovement = [];
    const firstDayPrice = data.price[0];

    let spyDailyPriceMovement = [];
    const spyFirstDayPrice = data.price_SPY[0];

    for (let i = 0; i < data.return.length; i++) {
        dailyPriceMovement.push(data.price[i] / firstDayPrice);
    }

    for (let i = 0; i < data.return_SPY.length; i++) {
        spyDailyPriceMovement.push(data.price_SPY[i] / spyFirstDayPrice);
    }

    // Initialize the chart with the Chart2 element
    var chart = echarts.init(document.getElementById("chart1"));

    // Configure and draw the chart
    chart.setOption({
        title: {
            text: 'Daily Price Movement of ' + symbol,
            left: 'center'
        },
        tooltip: {
            trigger: 'axis',
            position: function (pt) {
                return [pt[0], '10%'];
            }
        },
        xAxis: {
            type: "category",
            data: data.date,
            boundaryGap: false,
        },
        yAxis: {
            type: "value"
        },
        dataZoom: [
            {
                type: 'inside',
                start: 0,
                end: 10
            },
            {
                start: 0,
                end: 10
            }
        ],
        series: [{
            name: 'Daily Price Movement',
            data: dailyPriceMovement,
            type: "line",
            symbol: 'none'
        },
        {
            name: 'SPY Daily Price Movement',
            data: spyDailyPriceMovement,
            type: "line",
            symbol: 'none'
        }]
    });
}  

function draw_daily_price_change(data, symbol) {
    // Calculate daily price movement
    let dailyPriceChange = [];
    let spyDailyPriceChange = [];

    for (let i = 1; i < data.price.length; i++) {
        dailyPriceChange.push(data.price[i] / data.price[i - 1]);
    }

    for (let i = 1; i < data.price_SPY.length; i++) {
        spyDailyPriceChange.push(data.price_SPY[i] / data.price_SPY[i - 1]);
    }

    // Initialize the chart with the Chart2 element
    var chart = echarts.init(document.getElementById("chart2"));

    // Configure and draw the chart
    chart.setOption({
        title: {
            text: 'Daily Price Change of ' + symbol,
            left: 'center'
        },
        tooltip: {
            trigger: 'axis',
            position: function (pt) {
                return [pt[0], '10%'];
            }
        },
        // legend: {
        //     data: [symbol, 'SPY']
        // },
        xAxis: {
            type: "category",
            data: data.date,
            boundaryGap: false,
        },
        yAxis: {
            type: "value"
        },
        dataZoom: [
            {
                type: 'inside',
                start: 0,
                end: 10
            },
            {
                start: 0,
                end: 10
            }
        ],
        series: [{
            name: 'Daily Price Change',
            data: dailyPriceChange,
            type: "line",
            symbol: 'none'
        },
        {
            name: 'SPY Daily Price Change',
            data: spyDailyPriceChange,
            type: "line",
            symbol: 'none'
        }]
    });
}

function draw_scatter_graph(data, symbol) {
    const regressionModel = linearRegression(data.return_SPY, data.return);
    const slope = regressionModel.slope;
    const intercept = regressionModel.intercept;

    const xMin = Math.min(...data.return_SPY);
    const xMax = Math.max(...data.return_SPY);
    const lineStart = [xMin, xMin * slope + intercept];
    const lineEnd = [xMax, xMax * slope + intercept];

    const scatterData = data.return.map((value, index) => [data.return_SPY[index], value]);

    const chart = echarts.init(document.getElementById("chart3"));

    chart.setOption({
        title: {
            text: `Scatter Plot of ${symbol} Returns vs SPY Returns`,
            left: "center",
        },
        tooltip: {
            trigger: "axis",
            axisPointer: {
                type: "cross",
            },
        },
        xAxis: {
            type: "value",
            name: "SPY Returns",
        },
        yAxis: {
            type: "value",
            name: `${symbol} Returns`,
        },
        series: [
            {
                name: "Scatter",
                type: "scatter",
                data: scatterData,
                symbolSize: 1,
            },
            {
                name: "Linear Regression",
                type: "line",
                data: [lineStart, lineEnd],
                markLine: {
                    label: {
                        show: true,
                        formatter: "y = " + slope.toFixed(2) + "x + " + intercept.toFixed(2),
                    },
                },
            },
        ],
    });
}

function linearRegression(x, y) {
    const n = x.length;
    let sumX = 0;
    let sumY = 0;
    let sumXY = 0;
    let sumX2 = 0;

    for (let i = 0; i < n; i++) {
        sumX += x[i];
        sumY += y[i];
        sumXY += x[i] * y[i];
        sumX2 += x[i] * x[i];
    }

    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
    const intercept = (sumY - slope * sumX) / n;

    return { slope, intercept };
}
</script>
{% endblock %}